{% extends 'base.html' %}

{% block title %}药品库存 - 医药ERP系统{% endblock %}

{% block extra_css %}
<style>
    .inline-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .link-btn {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }
    .link-btn:hover { color: #1d4ed8; }
    .filter-form {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }
    .filter-form input {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
    }
    .pagination {
        margin-top: 1rem;
        text-align: center;
    }
    .pagination a {
        margin: 0 0.5rem;
        color: var(--primary-color);
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'index' %}">工作台</a> / 药品库存
</div>

<div class="page-header">
    <h1 class="page-title">药品库存列表</h1>
    <div class="inline-actions">
        <a class="link-btn" href="{% url 'medicine_info_list' %}"><i class="fa-solid fa-pills"></i> 药品信息</a>
        {% if perms.base.add_inventory %}
        <a class="link-btn" href="{% url 'inventory_create' %}"><i class="fa-solid fa-plus"></i> 新增库存批次</a>
        {% endif %}
    </div>
</div>

<!-- 搜索和筛选表单 -->
<form method="get" class="filter-form">
    <input type="text" name="search" placeholder="搜索药品名、厂家、批号" value="{{ search_query }}">
    <input type="number" name="min_quantity" placeholder="最小库存数量" value="{{ min_quantity }}">
    <input type="number" name="max_quantity" placeholder="最大库存数量" value="{{ max_quantity }}">
    <input type="date" name="expiry_start" placeholder="有效期开始" value="{{ expiry_start }}">
    <input type="date" name="expiry_end" placeholder="有效期结束" value="{{ expiry_end }}">
    <button type="submit" class="btn btn-primary">查询</button>
    <a href="{% url 'medicine_list' %}" class="btn btn-secondary">重置</a>
</form>

<div class="data-table-wrapper">
    <table class="data-table">
        <thead>
            <tr>
                <th>药品名称</th>
                <th>规格</th>
                <th>生产厂家</th>
                <th>批号</th>
                <th>有效期</th>
                <th>库存数量</th>
                <th>指导售价</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in inventory_items %}
            <tr>
                <td>{{ item.medicine.common_name }}</td>
                <td>{{ item.medicine.specification }}</td>
                <td>{{ item.medicine.manufacturer }}</td>
                <td>{{ item.batch_number }}</td>
                <td>
                    {{ item.expiry_date|date:"Y-m-d" }}
                    {% if item.is_expiring_soon %}
                    <span class="status-badge status-warning">临期</span>
                    {% endif %}
                </td>
                <td>
                    {{ item.quantity }}
                    {% if item.quantity < 10 %}
                    <span class="status-badge status-danger">缺货</span>
                    {% endif %}
                </td>
                <td>¥{{ item.medicine.sell_price }}</td>
                <td>
                    {% if perms.base.change_inventory %}
                    <a class="link-btn" href="{% url 'inventory_adjust' pk=item.id %}"><i class="fa-solid fa-rotate"></i> 调整库存</a>
                    &nbsp;|&nbsp;
                    <a class="link-btn" href="{% url 'inventory_edit' pk=item.id %}"><i class="fa-solid fa-pen-to-square"></i> 编辑库存</a>
                    {% else %}
                    <span style="color:#94a3b8;">无权限</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; color: #64748b; padding: 2rem;">
                    暂无库存记录
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- 分页导航 -->
    {% if inventory_items.has_other_pages %}
    <div class="pagination">
        {% if inventory_items.has_previous %}
        <a href="?page=1&search={{ search_query }}&min_quantity={{ min_quantity }}&max_quantity={{ max_quantity }}&expiry_start={{ expiry_start }}&expiry_end={{ expiry_end }}">首页</a>
        <a href="?page={{ inventory_items.previous_page_number }}&search={{ search_query }}&min_quantity={{ min_quantity }}&max_quantity={{ max_quantity }}&expiry_start={{ expiry_start }}&expiry_end={{ expiry_end }}">上一页</a>
        {% endif %}
        <span>第 {{ inventory_items.number }} 页，共 {{ inventory_items.paginator.num_pages }} 页</span>
        {% if inventory_items.has_next %}
        <a href="?page={{ inventory_items.next_page_number }}&search={{ search_query }}&min_quantity={{ min_quantity }}&max_quantity={{ max_quantity }}&expiry_start={{ expiry_start }}&expiry_end={{ expiry_end }}">下一页</a>
        <a href="?page={{ inventory_items.paginator.num_pages }}&search={{ search_query }}&min_quantity={{ min_quantity }}&max_quantity={{ max_quantity }}&expiry_start={{ expiry_start }}&expiry_end={{ expiry_end }}">末页</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}